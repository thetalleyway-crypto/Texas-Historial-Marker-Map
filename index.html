<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Historical Markers Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background:#f5f5f5;
}

#map-wrapper {
  width: 100%;
  max-width: 100vw;
  aspect-ratio: 9 / 16;
  position: relative;
  background: #ddd;
}

@supports not (aspect-ratio: 9 / 16) {
  #map-wrapper {
    height: 0;
    padding-bottom: 177.77%;
  }
}

#map {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}

#search-container {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:10;
  background:white;
  padding:6px 8px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  display:flex;
  gap:5px;
  width: calc(100% - 20px);
  max-width: 315px;
}

#search-input {
  flex:1;
  padding:6px;
  font-size:11px;
}

#search-btn {
  padding:6px 9px;
  font-size:11px;
  cursor:pointer;
}

.saved-msg {
  display:none;
  color:#28a745;
  font-size:12px;
}

@media (min-width: 900px) {
  #map-wrapper {
    max-width: 420px;
    margin: 0 auto;
  }
}
</style>
</head>
<body>

<div id="map-wrapper">
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Name or Marker #">
    <button id="search-btn">Search</button>
  </div>
  <div id="map"></div>
</div>

<script>
// ===== MAPBOX =====
mapboxgl.accessToken = "pk.eyJ1IjoiY3J0YWxsZXkiLCJhIjoiY21rNnhsZTBkMHk4ODNlb202azJyM3JmaSJ9.jCw9qqX8H4Rl2sLR0i3h-g";

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/streets-v12",
  center: [-96.334, 30.633],
  zoom: 11
});

// ===== FIREBASE =====
firebase.initializeApp({
  apiKey: "AIzaSyCF8oMdleFjzoC0QSJeq3BGBa1BUx8Mog8",
  databaseURL: "https://historicalmarkersmap-default-rtdb.firebaseio.com"
});
const db = firebase.database();

// ===== RESTORED STORAGE =====
const restoredMarkers = new Set();

function markerColorExpression() {
  return [
    "case",
    ["in",
      ["to-string", ["coalesce", ["get","MarkerNum"], ["get","markernum"]]],
      ["literal", Array.from(restoredMarkers)]
    ],
    "#28a745",
    "#c1121f"
  ];
}

// ===== MAP LOAD =====
map.on("load", () => {

  map.addSource("markers", {
    type: "vector",
    url: "mapbox://crtalley.c4hs1q9k"
  });

  map.addLayer({
    id: "markers-layer",
    type: "circle",
    source: "markers",
    "source-layer": "HistoricalMarkers",
    paint: {
      "circle-radius": 6,
      "circle-color": markerColorExpression(),
      "circle-stroke-width": 1,
      "circle-stroke-color": "#fff"
    }
  });

  // ===== LOCATE ME BUTTON =====
  map.addControl(
    new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    }),
    "bottom-right"
  );

  window.addEventListener("resize", () => map.resize());

  // ===== LIVE SYNC =====
  db.ref("markers").on("value", snap => {
    restoredMarkers.clear();
    if (snap.exists()) {
      Object.entries(snap.val()).forEach(([k,v]) => {
        if (v.restored) restoredMarkers.add(decodeURIComponent(k));
      });
    }
    map.setPaintProperty("markers-layer","circle-color",markerColorExpression());
  });

  // ===== POPUP WITH DIRECTIONS & RESTORED COLOR =====
  map.on("click", "markers-layer", async (e) => {
    const p = e.features[0].properties;
    const coords = e.features[0].geometry.coordinates;

    let id = p.MarkerNum || p.markernum;
    if (!id && p.Description) {
      const d = document.createElement("div");
      d.innerHTML = p.Description;
      const td = [...d.querySelectorAll("td")].find(t => t.textContent.trim() === "MarkerNum");
      id = td?.nextElementSibling?.textContent.trim();
    }
    id = id ? String(id).trim() : "Unknown";

    const popupDiv = document.createElement("div");
    popupDiv.innerHTML = `
      <div id="popup-content" style="min-width:250px; max-width:350px; display:flex; flex-direction:column; gap:6px; font-family: Arial, sans-serif;">
        <b>${p.Name || "No Name"}</b>
        <small>Marker #${id}</small>

        <div>
          <input type="checkbox" id="restored">
          <label for="restored">Restored</label>
        </div>

        <div>
          <label for="notes">Notes:</label>
          <textarea id="notes" rows="4" style="width:100%; box-sizing:border-box;"></textarea>
        </div>

        <button id="directions-btn" style="padding:6px; margin-top:4px; cursor:pointer;">Get Directions</button>

        <div class="saved-msg" id="savedMsg">Saved!</div>
      </div>
    `;

    const popup = new mapboxgl.Popup({ maxWidth: "350px" })
      .setLngLat(coords)
      .setDOMContent(popupDiv)
      .addTo(map);

    const restoredInput = popupDiv.querySelector("#restored");
    const notesInput = popupDiv.querySelector("#notes");
    const savedMsg = popupDiv.querySelector("#savedMsg");
    const directionsBtn = popupDiv.querySelector("#directions-btn");
    const popupContent = popupDiv.querySelector("#popup-content");

    // ===== AUTOSAVE =====
    const snap = await db.ref("markers/" + encodeURIComponent(id)).get();
    if (snap.exists()) {
      restoredInput.checked = snap.val().restored === true;
      notesInput.value = snap.val().notes || "";
    }

    const markerRef = db.ref("markers/" + encodeURIComponent(id));
    const listener = markerRef.on("value", snap => {
      if (!snap.exists()) return;
      restoredInput.checked = snap.val().restored === true;
      notesInput.value = snap.val().notes || "";
      // ===== Change popup background if restored =====
      popupContent.style.backgroundColor = restoredInput.checked ? "#999" : "#fff";
    });

    async function autoSave() {
      await markerRef.set({ restored: restoredInput.checked, notes: notesInput.value });
      savedMsg.style.display = "block";
      setTimeout(() => savedMsg.style.display = "none", 1000);
      popupContent.style.backgroundColor = restoredInput.checked ? "#999" : "#fff";
    }

    restoredInput.addEventListener("change", autoSave);
    notesInput.addEventListener("input", autoSave);

    // ===== DIRECTIONS BUTTON CLICK =====
    directionsBtn.addEventListener("click", () => {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}`;
      window.open(url, "_blank");
    });

    // Set initial popup color if already restored
    if (restoredInput.checked) {
      popupContent.style.backgroundColor = "#999";
    }

    popup.on("close", () => {
      markerRef.off("value", listener);
    });
  });

});
</script>

</body>
</html>
